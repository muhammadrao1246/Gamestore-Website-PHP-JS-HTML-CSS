<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="crop.css">
    <title>Document</title>

</head>
<body style="margin: 0;">





<div class="cropping-container" >

    <div class="cropper">
        <div class="loader-1">
            <span>Loading</span>
            <span class="rotate-animation">⟲</span>
        </div>
        <img src="" alt="" class="target" >
        <div draggable="true" class="resizable border-animation"></div>
    </div>

    <div class="processed">
        
        <input type="file" id="upload">
        
        <h4>Cropped Image !</h4>
        
        <div class="cropper" style="overflow: hidden;width: 162px;height: 162px;align-items: unset;">
            <div class="loader-1 loader-2">
                <span>Loading</span>
                <span class="rotate-animation">⟲</span>
            </div>
            <img src=""  alt="" class="target cropped_picture_container">
            <div class="cropped-image " id="capture"></div>
        </div>
        
        <div class="movement-handlers">
            <button class="left">❮</button>
            <div class="up-down">
                <button class="up" >❯</button>
                <button class="down" >❯</button>   
            </div>
            <button class="right">❯</button>
        </div>
    </div>
</div>

<div class="clone-storage" style="display: none;">

</div>

<div class="clone-source" style="display: none;">

</div>


<script>

    //initializing both picture containers 
    var crop_tool_window=document.getElementsByClassName('cropping-container')[0];

    var target_image=document.getElementsByClassName('target')[0];

    const loader=document.getElementsByClassName('loader-1');
    var loader_flag=0;
    loader[0].style.display="none";
    loader[1].style.display="none";

    var moving_div= document.getElementsByClassName('resizable')[0];
    moving_div.style.display="none";
    var current_left=current_top=0;
    var top_limit=left_limit =bottom_limit= right_limit =0;
    var div_top=div_left=0;

    var cropped_div=document.getElementsByClassName('cropped-image')[0];

    var dummy_image_original=document.getElementsByClassName('target')[1];

    //image which is uploaded
    var uploaded_image=document.getElementById('upload');
    
    var actual_width=actual_height=0;

    //showing uploadded picture in targeted div
    uploaded_image.onchange = function() 
    {
            loader_flag = 1;
            loader[0].style.display="flex";
            loader[1].style.display="flex";

            display_images();
            moving_div.style.display="none";
            
            
            //getting width and height
            setTimeout(() => {
                uploaded_picture_dimensions();
            }, 1500);


            setTimeout(() => {
                //reset moving divs
                set_moving_div_initially();
            }, 2000);

            setTimeout(() => {
                loader[0].style.display="none";
                loader[1].style.display="none";
                loader_flag = 0;
            }, 4000);
            
        }

    //showing picture after upload
    function display_images() 
    {
        
        //throwing sources

        target_image.src = URL.createObjectURL(uploaded_image.files[0]);

        dummy_image_original.src=target_image.src;//showing in dummy image 

        target_image.style.display="block";
        dummy_image_original.style.display="block";

        //remove background of cropped-image container
        cropped_div.style.backgroundImage = "unset";    
    }

    //saving current picture dimensions
    function uploaded_picture_dimensions() 
    {
        var picture_width  = Number((target_image.getBoundingClientRect().width));
        var picture_height = Number((target_image.getBoundingClientRect().height));
        
     
        //also set cropped image dimensions accroding to cropped section

        document.getElementsByClassName('cropper')[1].style.width = Number((cropped_div.getBoundingClientRect().width)) +'px';
        document.getElementsByClassName('cropper')[1].style.height= Number((cropped_div.getBoundingClientRect().height)) + 'px';
        
        //picture dimensions on view
        actual_width = picture_width - Number((cropped_div.getBoundingClientRect().width));
        actual_height = picture_height - Number((cropped_div.getBoundingClientRect().height));
    }

    //setting moving div position according to the image
    function set_moving_div_initially() 
    {
        
        console.log('Left: '+left_limit+' Top: '+top_limit+' bottom: '+bottom_limit+' right: '+right_limit);

        left_limit = current_left = Number(target_image.getBoundingClientRect().left);
        top_limit  = current_top = Number(target_image.getBoundingClientRect().top);

        bottom_limit = actual_height + Number(target_image.getBoundingClientRect().top);
        right_limit = actual_width + Number(target_image.getBoundingClientRect().left);
        
        console.log('Left: '+left_limit+' Top: '+top_limit+' bottom: '+bottom_limit+' right: '+right_limit);
        
        moving_div.style.left = current_left + 'px';
        moving_div.style.top  = current_top  + 'px';

        //crooped sector visible
        dummy_image_original.style.objectPosition="-"+(current_left - left_limit)+"px -"+(current_top - top_limit)+"px";

        //making visible moving div
        moving_div.style.display="block";
    }

      
        //movement handlers
        var left=document.getElementsByClassName('left')[0];

        var right=document.getElementsByClassName('right')[0];

        var up=document.getElementsByClassName('up')[0];

        var down=document.getElementsByClassName('down')[0];

    //movement listeners  and calculators  

    function remove_effect(btn) 
    {
        
            left.className.replace(btn,"");
            right.className.replace(btn,"");
            up.className.replace(btn,""); 
            down.className.replace(btn,"");
       
    }

    //onhold move as many pixel
    
    crop_tool_window.onkeydown = (e)=> {run_at_event(e);};
    function run_at_event(e)
    {
        console.log(e.key);
        if ( loader_flag != 1) 
        {
            if(e.key == 'ArrowUp') {
            move_up(Number(1));
            remove_effect(/( button_on)/);
            up.className+=" button_on";
            }
            if(e.key == 'ArrowDown') {
                move_down(Number(1));
                remove_effect(/( button_on)/);
                down.className+=" button_on";
            }
            if(e.key == 'ArrowLeft') {
                move_left(Number(1));
                remove_effect(/( button_on)/);
                left.className+=" button_on";
            }
            if(e.key == 'ArrowRight') {
                move_right(Number(1));
                remove_effect(/( button_on)/);
                right.className+=" button_on";
            }
        }
        
    }

    //movement functionality

    function get_current_position() 
    {
        current_top=  Number(moving_div.getBoundingClientRect().top);
        current_left= Number(moving_div.getBoundingClientRect().left); 
    }

    function move_left(inc)
    {
        get_current_position();
        if( current_left > left_limit )
        {
            div_left = current_left - 1;
            div_top=current_top;
        }
        Set_Position_of_moveable_div_and_cropped_container(); 
    }
    function move_right(inc)
    {
        get_current_position();
        if( current_left < right_limit )
        {
            div_left = current_left + 1;
            div_top=current_top;
        }
        Set_Position_of_moveable_div_and_cropped_container(); 
    }
    function move_up(inc)
    {
        get_current_position();
        if( current_top > top_limit )
        {
            div_top = current_top - 1;
            div_left=current_left;
        }      
        Set_Position_of_moveable_div_and_cropped_container(); 
    }
    function move_down(inc)
    {
        get_current_position();
        if( current_top < bottom_limit )
        {
            div_top = current_top + 1;
            div_left=current_left;
        }
        Set_Position_of_moveable_div_and_cropped_container();        
    }

    function Set_Position_of_moveable_div_and_cropped_container() 
    {
        console.log('After key press Top: '+div_top+' After Key Press Left: '+div_left);
        moving_div.style.top=div_top+'px';
        moving_div.style.left=div_left+'px';

        //crooped sector visible
        dummy_image_original.style.objectPosition="-"+(div_left - left_limit)+"px -"+(div_top - top_limit)+"px";

    }

</script>

</body>
</html>